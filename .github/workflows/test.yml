name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-attestation:
    name: Check Test Attestation
    runs-on: ubuntu-latest
    outputs:
      has_attestation: ${{ steps.attestation.outputs.has_attestation }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check for test attestation
        id: attestation
        run: |
          # On pull_request events, check the PR head commit
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
            git fetch origin "$COMMIT_SHA" --depth=1
            COMMIT_MSG=$(git log -1 --format=%B "$COMMIT_SHA")
            echo "Checking PR head commit: $COMMIT_SHA"
          else
            COMMIT_MSG=$(git log -1 --format=%B HEAD)
          fi

          if [[ "$COMMIT_MSG" == *"[steno-tests-passed:"* ]]; then
            echo "has_attestation=true" >> $GITHUB_OUTPUT
            echo "✅ Found [steno-tests-passed] attestation in commit message"
          else
            echo "has_attestation=false" >> $GITHUB_OUTPUT
            echo "⚠️ No [steno-tests-passed] attestation found"
          fi

  test:
    name: Build & Test
    needs: check-attestation
    runs-on: macos-15
    outputs:
      swift_version_ok: ${{ steps.check-swift.outputs.version_ok }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.0"

      - name: Check Swift version compatibility
        id: check-swift
        run: |
          INSTALLED=$(swift --version | head -1)
          echo "Installed: $INSTALLED"

          # Check required Swift version from Package.swift
          REQUIRED=$(grep swift-tools-version Package.swift | head -1 | sed 's/.*swift-tools-version: *//' | tr -d ' ')
          echo "Required: Swift $REQUIRED"

          # Extract major.minor from installed version
          INSTALLED_VER=$(swift --version | grep -oE '[0-9]+\.[0-9]+' | head -1)
          echo "Installed version: $INSTALLED_VER"

          # Compare versions
          if [[ "$(printf '%s\n' "$REQUIRED" "$INSTALLED_VER" | sort -V | head -1)" == "$INSTALLED_VER" && "$REQUIRED" != "$INSTALLED_VER" ]]; then
            echo "version_ok=false" >> $GITHUB_OUTPUT
            echo "⚠️ Swift $REQUIRED required but $INSTALLED_VER installed"
          else
            echo "version_ok=true" >> $GITHUB_OUTPUT
            echo "✅ Swift version compatible"
          fi

      - name: Build
        id: build
        if: steps.check-swift.outputs.version_ok == 'true'
        run: swift build -v

      - name: Run tests
        id: test
        if: steps.check-swift.outputs.version_ok == 'true'
        run: swift test -v

  result:
    name: CI Result
    needs: [check-attestation, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate CI result
        run: |
          SWIFT_OK="${{ needs.test.outputs.swift_version_ok }}"
          HAS_ATTESTATION="${{ needs.check-attestation.outputs.has_attestation }}"
          TEST_RESULT="${{ needs.test.result }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Swift version compatible: $SWIFT_OK"
          echo "Has test attestation: $HAS_ATTESTATION"
          echo "Test job result: $TEST_RESULT"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # If tests ran and passed, we're good
          if [[ "$TEST_RESULT" == "success" ]]; then
            echo "✅ Tests passed on CI"
            exit 0
          fi

          # If Swift version is incompatible but we have attestation, accept it
          if [[ "$SWIFT_OK" == "false" && "$HAS_ATTESTATION" == "true" ]]; then
            echo "✅ Swift version incompatible (needs macOS 26 / Swift 6.2)"
            echo "   Commit has local test attestation - accepting"
            echo ""
            echo "   Note: Tests will run automatically once GitHub runners"
            echo "   support macOS 26 and Swift 6.2+"
            exit 0
          fi

          # If Swift version is incompatible and no attestation, fail
          if [[ "$SWIFT_OK" == "false" && "$HAS_ATTESTATION" != "true" ]]; then
            echo "❌ Swift version incompatible and no test attestation found"
            echo ""
            echo "   This project requires macOS 26 / Swift 6.2 which isn't"
            echo "   available on GitHub runners yet."
            echo ""
            echo "   To pass CI, run tests locally and include attestation:"
            echo "   [steno-tests-passed: N tests in Xs]"
            exit 1
          fi

          # Otherwise tests failed for real
          echo "❌ Tests failed"
          exit 1

  lint:
    name: Swift Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check formatting (advisory)
        continue-on-error: true
        run: |
          echo "ℹ️ Swift format check skipped - requires macOS"
          echo "   Run locally: swift-format lint --recursive Sources Tests"
